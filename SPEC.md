# 鼻歌スコア表示アプリ 仕様書（初版）

## 目的とゴール
- ブラウザだけで鼻歌の音程をリアルタイムに可視化し、歌の精度向上をサポートする。
- 3 分以内のセッションで「音程が安定した」「ターゲットに近い」とユーザーが手応えを得る体験を作る。

## 想定ユーザー
- カラオケ練習や自宅での歌唱チェックをしたい一般ユーザー。
- 楽器を持たずにメロディ・アイデアを確認したいクリエイター。

## 主要ユースケース
- 鼻歌の音程ラインをリアルタイムに見る。
- 自分の鼻歌がどのキー（基準音）に相当するかを知る。
- サビなど 20〜30 秒の短い区間を繰り返し確認する。
- 歌い終わった後に簡易スコア（平均ピッチ誤差や安定度）を確認する。

## 成果物（MVP）
- Web アプリ（PC/スマホ対応）。ブラウザのマイク入力を許可して利用。
- リアルタイム波形／ピッチライン表示（50–100 ms 更新程度）。
- 基準キーの自動推定と、設定したキーとの差分表示。
- セッション履歴をローカルのみで保持（セッション終了で破棄）。
- 録音データはサーバーへ送信せず、ブラウザ内処理のみ。

## 画面構成（MVP）
- **ホーム/計測画面**
  - マイク許可プロンプト、入力レベルメーター。
  - ピッチライン表示（時間軸 x、音高 y: セント/半音の目盛り）。
  - ターゲットキー表示（例: C4=261.6Hz）と差分（±セント）。
  - 短いメトリクス: 平均誤差（セント）、安定度（標準偏差）。
  - セッション終了ボタンとリセットボタン。
- **結果ダイアログ（任意で後続）**
  - 平均ピッチ、誤差分布の簡易ヒストグラム。
  - 最も安定した 5 秒区間のハイライト。

## 機能要件
- マイク入力取得: MediaDevices.getUserMedia を用い、16k〜48kHz サンプリング。
- ピッチ推定: 自前実装（例: YIN/AMDF）または Web Audio API の AnalyserNode を用いた基本周波数推定。
- 更新レイテンシ: 入力から表示まで 200 ms 以内を目標。
- キー推定: 一定窓（例: 2–3 秒）で最頻ピッチを集計し近い音名を提示。
- 視覚化: Canvas または SVG でのラインプロット。過去 10–15 秒程度をスクロール表示。
- データ保持: 端末ローカルのみ。ブラウザ終了で消去。サーバーに音声・特徴量を送らない。
- エラーハンドリング: マイク拒否時はガイドを表示。ノイズ過多時は「入力レベル低/高」の警告。

## 非機能要件
- 対応ブラウザ: 最新 Chrome/Safari/Edge（モバイル含む）。Firefox はベストエフォート。
- パフォーマンス: 60 fps を維持できる描画を優先。重い処理は AudioWorklet などワーカースレッドに分離。
- アクセシビリティ: 文字サイズ最小 14px、コントラスト比 4.5:1 以上、キーボード操作可能。
- セキュリティ/プライバシー: HTTPS 前提。マイク許諾理由を明示。録音データを外部送信しない。

## アーキテクチャ（案）
- フロントエンドのみのシングルページ構成（JS/TS + Web Audio API + Canvas）。
- ピッチ抽出ロジックをユニットテスト可能なモジュールとして分離。
- UI 状態管理は軽量（例: React + hooks or 素の JS）で開始し、必要に応じて拡張。

## ピッチ検出方式とモジュール API（案）
- 方式: YIN（差分→累積平均→しきい値判定→パラボラ補間）を採用。音域 80–800 Hz を主対象。DC カットと軽いハイパスを前段に入れる。
- 実行基盤: AudioWorkletNode で検出処理を実行し、メインスレッドは描画に専念。AudioWorklet 非対応環境は ScriptProcessor にフォールバック（遅延は増えるが動作を確保）。
- 更新パラメータの目安: sampleRate 48kHz 前提で frameSize 2048, hopSize 256–512（約 5–10ms 間隔）、YIN しきい値 0.12 前後。入力レベルが一定以下の場合は「無音」として null を返す。
- 平滑化: 3–5 フレームの中央値フィルタで瞬間的な跳ねを抑制。信頼度（confidence）0.0–1.0 を算出し低信頼時は前値保持または null。
- 想定レイテンシ: マイク入力から結果通知まで 150–200 ms 以内（処理 + 描画）。
- 型イメージ（TS）:
  ```ts
  type PitchResult = {
    frequencyHz: number | null;
    midi: number | null;
    centsFromKey?: number; // 設定された基準キーとのズレ
    confidence: number;    // 0–1
    timestamp: number;     // AudioContext.currentTime を基準に ms
  };

  type PitchDetector = {
    start(stream: MediaStream): Promise<void>;
    stop(): Promise<void>;
    onResult(cb: (r: PitchResult) => void): void;
    setKey(frequencyHz: number): void; // centsFromKey 用
    dispose(): void;
  };

  function createPitchDetector(options?: {
    frameSize?: number;
    hopSize?: number;
    minFreq?: number;
    maxFreq?: number;
    yinThreshold?: number;
    energyThreshold?: number;
    forceScriptProcessor?: boolean;
  }): PitchDetector;
  ```
- エラーハンドリング: マイク拒否・AudioWorklet 未対応・音声デバイス未接続時は UI でガイドを表示し、検出モジュールは明示的に stop/dispose してリソースを解放。

## 設計方針（ピッチ検出まわり）
- 安定性優先で YIN を採用：倍音に比較的強く、80–800Hz の鼻歌・カラオケ帯で半音以上の誤検出を抑えやすい。
- リアルタイム性確保：hop 256–512 により 5–10ms 間隔で推定し、処理＋描画で 150–200ms 以内の体感遅延を目指す。
- メインスレッド負荷分散：AudioWorklet を基本にし、非対応ブラウザは ScriptProcessor をフォールバックとする。
- ロバスト化：低エネルギー時は無音扱い、信頼度を付与し中央値フィルタでスパイクを平滑化。キー差分計算用の setKey を API に含め UI 連携を簡潔にする。
- プライバシー：音声データはブラウザ内完結で外部送信しない。許諾失敗・未接続は UI ガイドで明示。

## 計測・品質
- テスト: ピッチ検出モジュールに対しサイン波/ノイズ/音程変化のフィクスチャを用意し精度を確認。
- 指標: 処理遅延（ms）、検出ミス率（半音以上の誤検出割合）、平均誤差（セント）。

## ロードマップ（短期）
1. ピッチ検出モジュールのプロトタイプ（ブラウザ内、静的ページ）。
2. キャンバスでのリアルタイム表示と入力レベルメーター。
3. キー推定・差分表示と簡易スコア算出。
4. UI 仕上げ（アクセシビリティ、モバイル最適化）。
